<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeHands - Full LLM Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header .version {
            font-size: 14px;
            opacity: 0.9;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .connected {
            background: #4CAF50;
            color: white;
        }

        .disconnected {
            background: #f44336;
            color: white;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
        }

        .message.system .message-content {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            text-align: center;
            font-style: italic;
        }

        .message.error .message-content {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-input:focus {
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .send-button:hover {
            transform: translateY(-2px);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .image-upload-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .image-upload-button:hover {
            transform: translateY(-2px);
        }

        .image-upload-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
        }

        .image-upload-container {
            display: none;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 10px 0;
        }

        .image-upload-container.show {
            display: block;
        }

        .image-upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .image-upload-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .confirm-upload {
            background: #28a745;
            color: white;
        }

        .cancel-upload {
            background: #6c757d;
            color: white;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .quick-action {
            background: #f0f0f0;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .quick-action:hover {
            background: #e0e0e0;
            transform: translateY(-1px);
        }

        .typing-indicator {
            display: none;
            padding: 10px 16px;
            color: #666;
            font-style: italic;
        }

        .typing-indicator.show {
            display: block;
        }

        .typing-dots {
            display: inline-block;
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0; }
            30% { opacity: 1; }
        }

        .interruption-alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            color: #856404;
        }

        .interruption-header {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .interruption-content {
            font-size: 14px;
        }

        .escalate-button {
            background: #ffc107;
            color: #212529;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }

        .escalate-button:hover {
            background: #e0a800;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="connection-status" id="connectionStatus">Connecting...</div>
            <h1>SafeHands </h1>
            <div class="version">Full LLM Agent - All responses generated by AI</div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message system">
                <div class="message-content">
                    Welcome to SafeHands ! This version uses a Full LLM Agent where all responses are generated by AI. Try asking me to help you order food from Swiggy!
                </div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <span class="typing-dots">ü§ñ AI is thinking...</span>
        </div>
        
        <div class="chat-input-container">
            <div class="quick-actions">
                <div class="quick-action" onclick="sendQuickMessage('I want to order food from Swiggy')">üçî Order Food</div>
                <div class="quick-action" onclick="sendQuickMessage('How do I open the app?')">‚ùì Ask Question</div>
                <div class="quick-action" onclick="sendQuickMessage('done')">‚úÖ Done</div>
                <div class="quick-action" onclick="sendQuickMessage('Hello there')">üëã Say Hello</div>
            </div>
            
            <div class="chat-input-wrapper">
                <input type="text" id="messageInput" class="chat-input" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                <button id="imageUploadButton" class="image-upload-button" onclick="triggerImageUpload()">üì∏</button>
                <button id="sendButton" class="send-button" onclick="sendMessage()">Send</button>
            </div>
            
            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
            
            <div id="imageUploadContainer" class="image-upload-container">
                <div id="imagePreview"></div>
                <div class="image-upload-actions">
                    <button class="confirm-upload" onclick="uploadImage()">Upload & Send</button>
                    <button class="cancel-upload" onclick="cancelImageUpload()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class SafeHandsChat {
            constructor() {
                this.ws = null;
                this.sessionId = 'v2_test_session_' + Date.now();
                this.interruptionCheckInterval = null;
                this.init();
            }

            init() {
                this.connectWebSocket();
                this.startInterruptionChecking();
            }

            connectWebSocket() {
                const wsUrl = `ws://localhost:8000/ws/${this.sessionId}`;
                console.log('ü§ñ [] Connecting to:', wsUrl);
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('ü§ñ [] WebSocket connected');
                    this.updateConnectionStatus('connected');
                };
                
                this.ws.onmessage = (event) => {
                    this.handleMessage(JSON.parse(event.data));
                };
                
                this.ws.onclose = () => {
                    console.log('ü§ñ [] WebSocket disconnected');
                    this.updateConnectionStatus('disconnected');
                    // Try to reconnect after 3 seconds
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('ü§ñ [] WebSocket error:', error);
                    this.updateConnectionStatus('disconnected');
                };
            }

            updateConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                if (status === 'connected') {
                    statusElement.textContent = 'Connected to ';
                    statusElement.className = 'connection-status connected';
                } else {
                    statusElement.textContent = 'Disconnected';
                    statusElement.className = 'connection-status disconnected';
                }
            }

            sendMessage(text = null) {
                const messageInput = document.getElementById('messageInput');
                const message = text || messageInput.value.trim();

                if (!message) return;

                messageInput.value = '';
                this.addMessage(message, 'user');
                this.showTypingIndicator();

                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    console.log('ü§ñ [] Sending:', message);
                    const messageData = {
                        message_type: 'text',
                        data: {
                            session_id: this.sessionId,
                            text: message,
                            timestamp: new Date().toISOString(),
                            language: 'en-US'
                        }
                    };
                    this.ws.send(JSON.stringify(messageData));
                } else {
                    this.hideTypingIndicator();
                    this.addSystemMessage('WebSocket not connected. Please refresh the page.', 'error');
                }
            }

            sendQuickMessage(message) {
                document.getElementById('messageInput').value = message;
                this.sendMessage();
            }

            handleMessage(data) {
                console.log('ü§ñ [] Received message:', data);
                this.hideTypingIndicator();

                if (data.message_type === 'response' && data.data && data.data.type === 'connection_established') {
                    console.log('Connected to SafeHands ');
                    return;
                }
                if (data.message_type === 'heartbeat') {
                    console.log('Heartbeat received');
                    return;
                }
                if (data.message_type === 'error') {
                    this.addSystemMessage(`Error: ${data.data?.error_message || 'Unknown error'}`, 'error');
                    return;
                }

                if (data.message_type === 'response' && data.data) {
                    const responseData = data.data;
                    const content = responseData.content;
                    const responseType = responseData.type;

                    if (content) {
                        this.addMessage(content, 'assistant');
                        this.speak(content);
                    } else {
                        console.log('No content in response:', responseData);
                    }
                } else if (data.type === 'error') {
                    this.addSystemMessage(`Error: ${data.message}`, 'error');
                    return;
                } else {
                    console.log('Unknown message type:', data);
                }
            }

            addMessage(content, type) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                
                messageDiv.appendChild(contentDiv);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            addSystemMessage(content, type = 'system') {
                this.addMessage(content, type);
            }

            showTypingIndicator() {
                document.getElementById('typingIndicator').classList.add('show');
            }

            hideTypingIndicator() {
                document.getElementById('typingIndicator').classList.remove('show');
            }

            speak(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.rate = 0.9;
                    utterance.pitch = 1;
                    speechSynthesis.speak(utterance);
                }
            }

            startInterruptionChecking() {
                this.interruptionCheckInterval = setInterval(() => {
                    this.checkForInterruptions();
                }, 2000);
            }

            stopInterruptionChecking() {
                if (this.interruptionCheckInterval) {
                    clearInterval(this.interruptionCheckInterval);
                    this.interruptionCheckInterval = null;
                }
            }

            async checkForInterruptions() {
                try {
                    const response = await fetch(`http://localhost:8000/workflow/interruption/${this.sessionId}`);
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.interruption) {
                        this.displayInterruption(data.interruption);
                        // Mark as escalated
                        await fetch(`http://localhost:8000/workflow/interruption/${this.sessionId}/escalated`, {
                            method: 'POST'
                        });
                    }
                } catch (error) {
                    console.log('No interruption found or error:', error);
                }
            }

            displayInterruption(interruption) {
                const messagesContainer = document.getElementById('chatMessages');
                const interruptionDiv = document.createElement('div');
                interruptionDiv.className = 'interruption-alert';
                interruptionDiv.innerHTML = `
                    <div class="interruption-header">üö® User Question Detected</div>
                    <div class="interruption-content">
                        <strong>Question:</strong> ${interruption.user_input}<br>
                        <strong>Current Step:</strong> ${interruption.current_step}<br>
                        <strong>Progress:</strong> ${interruption.current_step_index + 1} of ${interruption.total_steps}
                    </div>
                `;
                messagesContainer.appendChild(interruptionDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Image upload methods
            triggerImageUpload() {
                document.getElementById('imageInput').click();
            }

            handleImageSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.selectedImage = file;
                    this.showImagePreview(file);
                }
            }

            showImagePreview(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('imagePreview');
                    preview.innerHTML = `
                        <img src="${e.target.result}" class="image-preview" alt="Preview">
                        <p>Selected: ${file.name}</p>
                    `;
                    document.getElementById('imageUploadContainer').classList.add('show');
                };
                reader.readAsDataURL(file);
            }

            async uploadImage() {
                if (!this.selectedImage) return;

                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim() || "Please help me with this screenshot";

                // Add user message to chat
                this.addMessage(`üì∏ ${message}`, 'user');
                messageInput.value = '';
                this.showTypingIndicator();

                // Hide image upload container
                document.getElementById('imageUploadContainer').classList.remove('show');

                try {
                    const formData = new FormData();
                    formData.append('session_id', this.sessionId);
                    formData.append('message', message);
                    formData.append('image', this.selectedImage);

                    console.log('üì∏ [] Uploading image with message:', message);

                    const response = await fetch('http://localhost:8000/api/upload-screenshot', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('üì∏ [] Image upload response:', data);

                    this.hideTypingIndicator();
                    this.addMessage(data.content, 'assistant');

                } catch (error) {
                    console.error('üì∏ [] Error uploading image:', error);
                    this.hideTypingIndicator();
                    this.addSystemMessage('Sorry, there was an error uploading your image. Please try again.', 'error');
                }

                // Clear selected image
                this.selectedImage = null;
                document.getElementById('imageInput').value = '';
            }

            cancelImageUpload() {
                document.getElementById('imageUploadContainer').classList.remove('show');
                document.getElementById('imagePreview').innerHTML = '';
                this.selectedImage = null;
                document.getElementById('imageInput').value = '';
            }
        }

        // Initialize chat
        const chat = new SafeHandsChat();

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            chat.sendMessage();
        }

        function sendQuickMessage(message) {
            chat.sendQuickMessage(message);
        }

        function triggerImageUpload() {
            chat.triggerImageUpload();
        }

        function handleImageSelect(event) {
            chat.handleImageSelect(event);
        }

        function uploadImage() {
            chat.uploadImage();
        }

        function cancelImageUpload() {
            chat.cancelImageUpload();
        }
    </script>
</body>
</html>
